@section styles{
    <style type="text/css">
        /* 这里复制 Create.cshtml 中的所有样式代码 */
        .expression-fields {
            display: flex;
            flex-wrap: nowrap;
            gap: 5px;
            margin-top: 10px;
            width: 100%;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .field-group {
            display: flex;
            align-items: center;
            flex: 0 0 auto;
            min-width: 60px;
        }

        .field-label {
            min-width: 30px;
            text-align: right;
            margin-right: 5px;
            color: #555;
            font-weight: normal;
            font-size: 12px;
        }

        .field-group .form-control {
            width: 50px;
            min-width: 50px;
            text-align: center;
            border-radius: 4px;
            border: 1px solid #ddd;
            background-color: #fff;
            padding: 2px 5px;
            font-size: 12px;
        }

        .field-group .form-control[readonly] {
            background-color: #fff;
            cursor: default;
        }

        .modal-lg {
            width: 800px;
        }

        .modal-body {
            padding: 15px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .expression-area {
            background-color: #f8f8f8;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 0;
        }

        #cronExpression {
            font-family: monospace;
            letter-spacing: 1px;
            width: 100%;
            margin-top: 10px;
        }

        /* 新增样式 */
        .alert {
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid transparent;
            border-radius: 4px;
        }

        .alert-success {
            color: #3c763d;
            background-color: #dff0d8;
            border-color: #d6e9c6;
        }

        .alert-danger {
            color: #a94442;
            background-color: #f2dede;
            border-color: #ebccd1;
        }

        .well {
            min-height: 20px;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f5f5f5;
            border: 1px solid #e3e3e3;
            border-radius: 4px;
        }

        .well-sm {
            padding: 5px;
            border-radius: 3px;
        }

        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .btn-group .btn {
            margin-right: 5px;
            margin-bottom: 5px;
        }

        .table {
            width: 100%;
            margin-bottom: 20px;
            border-collapse: collapse;
        }

        .table-bordered {
            border: 1px solid #ddd;
        }

        .table-striped > tbody > tr:nth-of-type(odd) {
            background-color: #f9f9f9;
        }

        .table > thead > tr > th,
        .table > tbody > tr > td {
            padding: 8px;
            line-height: 1.42857143;
            vertical-align: top;
            border-top: 1px solid #ddd;
        }

        .table > thead > tr > th {
            vertical-align: bottom;
            border-bottom: 2px solid #ddd;
        }

        .table-bordered > thead > tr > th,
        .table-bordered > tbody > tr > td {
            border: 1px solid #ddd;
        }

        code {
            padding: 2px 4px;
            font-size: 90%;
            color: #c7254e;
            background-color: #f9f2f4;
            border-radius: 4px;
        }

        .fa-question-circle {
            color: #337ab7;
            margin-right: 5px;
        }

        .panel {
            margin-bottom: 20px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .panel-heading {
            padding: 10px 15px;
            border-bottom: 1px solid #ddd;
            border-top-left-radius: 3px;
            border-top-right-radius: 3px;
        }

        .panel-title {
            margin-top: 0;
            margin-bottom: 0;
            font-size: 16px;
            color: inherit;
        }

        .panel-body {
            padding: 15px;
        }

        /* 修改模态框样式 */
        .modal-dialog.modal-lg {
            width: 900px;
            max-width: 90%;
            margin: 30px auto;
        }

        .modal-content {
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            flex-shrink: 0;
        }

        .modal-body {
            flex: 1 1 auto;
            overflow-y: auto;
            max-height: calc(90vh - 120px);
            padding: 15px;
        }

        .modal-footer {
            flex-shrink: 0;
        }

        /* 优化选项卡样式 */
        .nav-tabs {
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }

        .nav-tabs > li {
            margin-bottom: -1px;
        }

        .nav-tabs > li > a {
            padding: 8px 12px;
            margin-right: 2px;
            line-height: 1.42857143;
            border: 1px solid transparent;
            border-radius: 4px 4px 0 0;
        }

        .nav-tabs > li.active > a,
        .nav-tabs > li.active > a:hover,
        .nav-tabs > li.active > a:focus {
            color: #555;
            background-color: #fff;
            border: 1px solid #ddd;
            border-bottom-color: transparent;
            cursor: default;
        }

        /* 优化表达式区域样式 */
        .expression-area {
            background-color: #f8f8f8;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 20px;
        }

        .expression-fields {
            display: flex;
            flex-wrap: nowrap;
            gap: 5px;
            margin-top: 10px;
            width: 100%;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .field-group {
            display: flex;
            align-items: center;
            flex: 0 0 auto;
            min-width: 60px;
        }

        .field-label {
            min-width: 30px;
            text-align: right;
            margin-right: 5px;
            color: #555;
            font-weight: normal;
            font-size: 12px;
        }

        .field-group .form-control {
            width: 50px;
            min-width: 50px;
            text-align: center;
            border-radius: 4px;
            border: 1px solid #ddd;
            background-color: #fff;
            padding: 2px 5px;
            font-size: 12px;
        }

        /* 优化按钮组样式 */
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }

        .btn-group .btn {
            margin-right: 5px;
            margin-bottom: 5px;
            white-space: nowrap;
        }

        /* 优化帮助信息样式 */
        #expressionHelp {
            max-height: 400px;
            overflow-y: auto;
        }

        #expressionHelp table {
            margin-bottom: 15px;
        }

        #expressionHelp code {
            padding: 2px 4px;
            font-size: 90%;
            color: #c7254e;
            background-color: #f9f2f4;
            border-radius: 4px;
        }

        /* 优化验证和预览区域样式 */
        #expressionValidation,
        #nextExecutionTime {
            margin-top: 10px;
            padding: 10px;
        }

        /* 优化滚动条样式 */
        .modal-body::-webkit-scrollbar,
        #expressionHelp::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .modal-body::-webkit-scrollbar-track,
        #expressionHelp::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .modal-body::-webkit-scrollbar-thumb,
        #expressionHelp::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        .modal-body::-webkit-scrollbar-thumb:hover,
        #expressionHelp::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
}

<div class="page-body">
    <div class="widget">
        <div class="widget-header bordered-bottom bordered-lightred">
            <span class="widget-caption">修改任务</span>
        </div>
        <div class="widget-body">
            <div id="horizontal-form">
                <form class="form-horizontal" action="/api/Task/EditTask" data-ajax="true" data-ajax-method="post" id="form1" data-ajax-complete="handlers.onComplete" data-ajax-begin="handlers.beforeSubmit" novalidate="novalidate">
                    <div class="tabbable">
                        <ul class="nav nav-tabs" id="myTab">
                            <li class="active">
                                <a data-toggle="tab" href="#group_base">基础信息配置</a>
                            </li>
                            <li class="">
                                <a data-toggle="tab" href="#group_params">自定义参数</a>
                            </li>
                            <li class="">
                                <a data-toggle="tab" href="#group_exception">异常报警通知</a>
                            </li>
                        </ul>
                        <div class="tab-content">
                            <div id="group_base" class="tab-pane active">
                                <input type="hidden" value="" id="id" name="id" />
                                <div class="form-group">
                                    <label for="" class="col-sm-2 control-label no-padding-right">任务名称</label>
                                    <div class="col-sm-6">
                                        <input type="text" name="Title" class="form-control" id="Title" required="" placeholder="">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="" class="col-sm-2 control-label no-padding-right">开始时间</label>
                                    <div class="col-sm-6">
                                        <span class="input-icon icon-right">
                                            <input type="text" class="form-control date-picker" name="StartDate" id="StartDate" placeholder="">
                                            <i class="fa fa-calendar"></i>
                                        </span>
                                        <p class="help-block">为空表示不限制开始时间</p>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="" class="col-sm-2 control-label no-padding-right">按周期运行</label>
                                    <div class="col-sm-6">
                                        <label>
                                            <input class="checkbox-slider toggle colored-blue yesno" checked="" name="RunLoop" id="RunLoop" type="checkbox" value="true">
                                            <span class="text" style="margin-top: 5px;"></span>
                                        </label>
                                        <p class="help-block">如果关闭按钮表示在任务开始时只执行一次</p>
                                    </div>
                                </div>
                                <div class="form-group" id="ctn_CronExpression">
                                    <label for="" class="col-sm-2 control-label no-padding-right">Cron表达式</label>
                                    <div class="col-sm-6">
                                        <div class="input-group">
                                            <input type="text" class="form-control" name="CronExpression" id="CronExpression" placeholder="" style="min-width:460px;">
                                            <span class="input-group-btn">
                                                <button type="button" class="btn btn-primary" onclick="showCronModal()">
                                                    <i class="fa fa-clock-o"></i> 生成表达式
                                                </button>
                                            </span>
                                        </div>
                                        <p class="help-block">点击"生成表达式"按钮，使用表达式生成器</p>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="" class="col-sm-2 control-label no-padding-right">停止时间</label>
                                    <div class="col-sm-6">
                                        <span class="input-icon icon-right">
                                            <input type="text" class="form-control" name="EndDate" id="EndDate" placeholder="">
                                            <i class="fa fa-calendar"></i>
                                        </span>
                                        <p class="help-block">为空表示不限制停止时间</p>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="" class="col-sm-2 control-label no-padding-right">程序集名称</label>
                                    <div class="col-sm-6">
                                        <input type="text" class="form-control" name="AssemblyName" id="AssemblyName" placeholder="" required="">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="" class="col-sm-2 control-label no-padding-right">执行类名称</label>
                                    <div class="col-sm-6">
                                        <input type="text" class="form-control" name="ClassName" id="ClassName" placeholder="" required="">
                                        <p class="help-block">包含命名空间的完整类名</p>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="" class="col-sm-2 control-label no-padding-right">自定义参数</label>
                                    <div class="col-sm-6">
                                        <textarea class="form-control" name="CustomParamsJson" id="CustomParamsJson" placeholder=""></textarea>
                                        <p class="help-block">多个参数建议使用Json格式的字符串</p>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="" class="col-sm-2 control-label no-padding-right">备注</label>
                                    <div class="col-sm-6">
                                        <textarea class="form-control" name="Remark" id="Remark" placeholder=""></textarea>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="col-sm-offset-2 col-sm-10">
                                        <button type="submit" class="btn btn-primary">保  存</button>
                                        <button type="button" class="btn btn-default" onclick="history.back();">返  回</button>
                                    </div>
                                </div>
                            </div>
                            <div id="group_params" class="tab-pane"></div>
                            <div id="group_exception" class="tab-pane"></div>
                        </div>
                    </div>
                </form>
                <hr />
                <section>
                    <p>注意事项：</p>
                    <ul>
                        <li>任务启动前请确认运行所需要的程序集文件和配置文件都已上传到指定目录，否则将无法启动。</li>
                        <li>每个任务的专属目录在任务调度平台中的路径【/TaskAssembly/程序集名称/】下，例如：/TaskAssembly/MyTestDemo/。</li>
                        <li>任务程序集尽可能少的依赖于其他程序集。</li>
                        <li>任务的配置信息可以使用单独的.config配置文件存储，不要修改调度平台的web.config。</li>
                    </ul>
                </section>
            </div>
        </div>
    </div>
</div>

<!-- Cron表达式生成器模态框 -->
<div class="modal fade" id="cronModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                <h4 class="modal-title">Cron表达式生成器</h4>
            </div>
            <div class="modal-body">
                <!-- 选项卡导航 -->
                <ul class="nav nav-tabs" role="tablist">
                    <li role="presentation" class="active"><a href="#secondTab" role="tab" data-toggle="tab">秒</a></li>
                    <li role="presentation"><a href="#minuteTab" role="tab" data-toggle="tab">分钟</a></li>
                    <li role="presentation"><a href="#hourTab" role="tab" data-toggle="tab">小时</a></li>
                    <li role="presentation"><a href="#dayTab" role="tab" data-toggle="tab">日</a></li>
                    <li role="presentation"><a href="#monthTab" role="tab" data-toggle="tab">月份</a></li>
                    <li role="presentation"><a href="#weekTab" role="tab" data-toggle="tab">周（星期）</a></li>
                    <li role="presentation"><a href="#yearTab" role="tab" data-toggle="tab">年份</a></li>
                </ul>

                <!-- 选项卡内容 -->
                <div class="tab-content" style="padding: 15px;">
                    <!-- 秒 -->
                    <div role="tabpanel" class="tab-pane active" id="secondTab">
                        <div class="form-group">
                            <label class="radio-inline">
                                <input type="radio" name="secondType" value="*" checked onclick="updateField('second')"> 每秒 允许的通配符[, - * /]
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="radio-inline">
                                <input type="radio" name="secondType" value="period" onclick="updateField('second')"> 周期 从
                                <input type="number" id="secondStart" class="form-control input-sm" style="display: inline-block; width: 80px;" onchange="updateField('second')"> -
                                <input type="number" id="secondEnd" class="form-control input-sm" style="display: inline-block; width: 80px;" onchange="updateField('second')"> 秒
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="radio-inline">
                                <input type="radio" name="secondType" value="loop" onclick="updateField('second')"> 从
                                <input type="number" id="secondBegin" class="form-control input-sm" style="display: inline-block; width: 80px;" onchange="updateField('second')"> 秒开始每
                                <input type="number" id="secondInterval" class="form-control input-sm" style="display: inline-block; width: 80px;" onchange="updateField('second')"> 秒执行一次
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="radio-inline">
                                <input type="radio" name="secondType" value="specific" onclick="updateField('second')"> 指定
                            </label>
                            <div class="checkbox-list" style="margin-top: 10px;">
                                @for (int i = 0; i < 60; i++)
                                {
                                    <label class="checkbox-inline">
                                        <input type="checkbox" class="second-checkbox" value="@(i.ToString("00"))" onclick="updateField('second')"> @(i.ToString("00"))
                                    </label>
                                    if ((i + 1) % 10 == 0)
                                    {
                                        <br/>
                                    }
                                }
                            </div>
                        </div>
                    </div>

                    <!-- 分钟 -->
                    <div role="tabpanel" class="tab-pane" id="minuteTab">
                        <div class="form-group">
                            <label class="radio-inline">
                                <input type="radio" name="minuteType" value="*" checked onclick="updateField('minute')"> 每分钟 允许的通配符[, - * /]
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="radio-inline">
                                <input type="radio" name="minuteType" value="period" onclick="updateField('minute')"> 周期 从
                                <input type="number" id="minuteStart" class="form-control input-sm" style="display: inline-block; width: 80px;" onchange="updateField('minute')"> -
                                <input type="number" id="minuteEnd" class="form-control input-sm" style="display: inline-block; width: 80px;" onchange="updateField('minute')"> 分钟
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="radio-inline">
                                <input type="radio" name="minuteType" value="loop" onclick="updateField('minute')"> 从
                                <input type="number" id="minuteBegin" class="form-control input-sm" style="display: inline-block; width: 80px;" onchange="updateField('minute')"> 分钟开始每
                                <input type="number" id="minuteInterval" class="form-control input-sm" style="display: inline-block; width: 80px;" onchange="updateField('minute')"> 分钟执行一次
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="radio-inline">
                                <input type="radio" name="minuteType" value="specific" onclick="updateField('minute')"> 指定
                            </label>
                            <div class="checkbox-list" style="margin-top: 10px;">
                                @for (int i = 0; i < 60; i++)
                                {
                                    <label class="checkbox-inline">
                                        <input type="checkbox" class="minute-checkbox" value="@(i.ToString("00"))" onclick="updateField('minute')"> @(i.ToString("00"))
                                    </label>
                                    if ((i + 1) % 10 == 0)
                                    {
                                        <br/>
                                    }
                                }
                            </div>
                        </div>
                    </div>

                    <!-- 小时 -->
                    <div role="tabpanel" class="tab-pane" id="hourTab">
                        <div class="form-group">
                            <label class="radio-inline">
                                <input type="radio" name="hourType" value="*" checked onclick="updateField('hour')"> 每小时 允许的通配符[, - * /]
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="radio-inline">
                                <input type="radio" name="hourType" value="period" onclick="updateField('hour')"> 周期 从
                                <input type="number" id="hourStart" class="form-control input-sm" style="display: inline-block; width: 80px;" onchange="updateField('hour')"> -
                                <input type="number" id="hourEnd" class="form-control input-sm" style="display: inline-block; width: 80px;" onchange="updateField('hour')"> 小时
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="radio-inline">
                                <input type="radio" name="hourType" value="loop" onclick="updateField('hour')"> 从
                                <input type="number" id="hourBegin" class="form-control input-sm" style="display: inline-block; width: 80px;" onchange="updateField('hour')"> 小时开始每
                                <input type="number" id="hourInterval" class="form-control input-sm" style="display: inline-block; width: 80px;" onchange="updateField('hour')"> 小时执行一次
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="radio-inline">
                                <input type="radio" name="hourType" value="specific" onclick="updateField('hour')"> 指定
                            </label>
                            <div class="checkbox-list" style="margin-top: 10px;">
                                @for (int i = 0; i < 24; i++)
                                {
                                    <label class="checkbox-inline">
                                        <input type="checkbox" class="hour-checkbox" value="@(i.ToString("00"))" onclick="updateField('hour')"> @(i.ToString("00"))
                                    </label>
                                    if ((i + 1) % 6 == 0)
                                    {
                                        <br/>
                                    }
                                }
                            </div>
                        </div>
                    </div>

                    <!-- 日 -->
                    <div role="tabpanel" class="tab-pane" id="dayTab">
                        <div class="form-group">
                            <label class="radio-inline">
                                <input type="radio" name="dayType" value="*" checked onclick="updateField('day')"> 每日 允许的通配符[, - * / L W]
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="radio-inline">
                                <input type="radio" name="dayType" value="?" onclick="updateField('day')"> 不指定
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="radio-inline">
                                <input type="radio" name="dayType" value="period" onclick="updateField('day')"> 周期 从
                                <input type="number" id="dayStart" class="form-control input-sm" style="display: inline-block; width: 80px;" onchange="updateField('day')"> -
                                <input type="number" id="dayEnd" class="form-control input-sm" style="display: inline-block; width: 80px;" onchange="updateField('day')"> 日
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="radio-inline">
                                <input type="radio" name="dayType" value="loop" onclick="updateField('day')"> 从
                                <input type="number" id="dayBegin" class="form-control input-sm" style="display: inline-block; width: 80px;" onchange="updateField('day')"> 日开始每
                                <input type="number" id="dayInterval" class="form-control input-sm" style="display: inline-block; width: 80px;" onchange="updateField('day')"> 天执行一次
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="radio-inline">
                                <input type="radio" name="dayType" value="work" onclick="updateField('day')"> 每月
                                <input type="number" id="dayWork" class="form-control input-sm" style="display: inline-block; width: 80px;" onchange="updateField('day')"> 号最近的工作日
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="radio-inline">
                                <input type="radio" name="dayType" value="last" onclick="updateField('day')"> 本月最后一天
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="radio-inline">
                                <input type="radio" name="dayType" value="specific" onclick="updateField('day')"> 指定
                            </label>
                            <div class="checkbox-list" style="margin-top: 10px;">
                                @for (int i = 1; i <= 31; i++)
                                {
                                    <label class="checkbox-inline">
                                        <input type="checkbox" class="day-checkbox" value="@(i.ToString())" onclick="updateField('day')"> @(i.ToString())
                                    </label>
                                    if (i % 7 == 0)
                                    {
                                        <br/>
                                    }
                                }
                            </div>
                        </div>
                    </div>

                    <!-- 月份 -->
                    <div role="tabpanel" class="tab-pane" id="monthTab">
                        <div class="form-group">
                            <label class="radio-inline">
                                <input type="radio" name="monthType" value="*" checked onclick="updateField('month')"> 每月 允许的通配符[, - * /]
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="radio-inline">
                                <input type="radio" name="monthType" value="period" onclick="updateField('month')"> 周期 从
                                <input type="number" id="monthStart" class="form-control input-sm" style="display: inline-block; width: 80px;" onchange="updateField('month')"> -
                                <input type="number" id="monthEnd" class="form-control input-sm" style="display: inline-block; width: 80px;" onchange="updateField('month')"> 月
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="radio-inline">
                                <input type="radio" name="monthType" value="loop" onclick="updateField('month')"> 从
                                <input type="number" id="monthBegin" class="form-control input-sm" style="display: inline-block; width: 80px;" onchange="updateField('month')"> 月开始每
                                <input type="number" id="monthInterval" class="form-control input-sm" style="display: inline-block; width: 80px;" onchange="updateField('month')"> 月执行一次
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="radio-inline">
                                <input type="radio" name="monthType" value="specific" onclick="updateField('month')"> 指定
                            </label>
                            <div class="checkbox-list" style="margin-top: 10px;">
                                @for (int i = 1; i <= 12; i++)
                                {
                                    <label class="checkbox-inline">
                                        <input type="checkbox" class="month-checkbox" value="@(i.ToString())" onclick="updateField('month')"> @(i.ToString())月
                                    </label>
                                    if (i % 6 == 0)
                                    {
                                        <br/>
                                    }
                                }
                            </div>
                        </div>
                    </div>

                    <!-- 周（星期） -->
                    <div role="tabpanel" class="tab-pane" id="weekTab">
                        <div class="form-group">
                            <label class="radio-inline">
                                <input type="radio" name="weekType" value="*" checked onclick="updateField('week')"> 每周 允许的通配符[, - * / L #]
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="radio-inline">
                                <input type="radio" name="weekType" value="?" onclick="updateField('week')"> 不指定
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="radio-inline">
                                <input type="radio" name="weekType" value="period" onclick="updateField('week')"> 周期 从星期
                                <input type="number" id="weekStart" class="form-control input-sm" style="display: inline-block; width: 80px;" onchange="updateField('week')"> -
                                <input type="number" id="weekEnd" class="form-control input-sm" style="display: inline-block; width: 80px;" onchange="updateField('week')">
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="radio-inline">
                                <input type="radio" name="weekType" value="last" onclick="updateField('week')"> 本月最后一个星期
                                <select class="form-control input-sm" style="display: inline-block; width: 80px;" id="weekLast" onchange="updateField('week')">
                                    <option value="1">一</option>
                                    <option value="2">二</option>
                                    <option value="3">三</option>
                                    <option value="4">四</option>
                                    <option value="5">五</option>
                                    <option value="6">六</option>
                                    <option value="7">日</option>
                                </select>
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="radio-inline">
                                <input type="radio" name="weekType" value="specific" onclick="updateField('week')"> 指定
                            </label>
                            <div class="checkbox-list" style="margin-top: 10px;">
                                <label class="checkbox-inline">
                                    <input type="checkbox" class="week-checkbox" value="1" onclick="updateField('week')"> 周一
                                </label>
                                <label class="checkbox-inline">
                                    <input type="checkbox" class="week-checkbox" value="2" onclick="updateField('week')"> 周二
                                </label>
                                <label class="checkbox-inline">
                                    <input type="checkbox" class="week-checkbox" value="3" onclick="updateField('week')"> 周三
                                </label>
                                <label class="checkbox-inline">
                                    <input type="checkbox" class="week-checkbox" value="4" onclick="updateField('week')"> 周四
                                </label>
                                <label class="checkbox-inline">
                                    <input type="checkbox" class="week-checkbox" value="5" onclick="updateField('week')"> 周五
                                </label>
                                <label class="checkbox-inline">
                                    <input type="checkbox" class="week-checkbox" value="6" onclick="updateField('week')"> 周六
                                </label>
                                <label class="checkbox-inline">
                                    <input type="checkbox" class="week-checkbox" value="7" onclick="updateField('week')"> 周日
                                </label>
                                <br/>
                                <label class="checkbox-inline">
                                    <input type="checkbox" class="week-checkbox" value="1-5" onclick="updateField('week')"> 工作日
                                </label>
                                <label class="checkbox-inline">
                                    <input type="checkbox" class="week-checkbox" value="6,7" onclick="updateField('week')"> 周末
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- 年份 -->
                    <div role="tabpanel" class="tab-pane" id="yearTab">
                        <div class="form-group">
                            <label class="radio-inline">
                                <input type="radio" name="yearType" value="?" checked onclick="updateField('year')"> 不指定 允许的通配符[, - * /]非必填
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="radio-inline">
                                <input type="radio" name="yearType" value="*" onclick="updateField('year')"> 每年
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="radio-inline">
                                <input type="radio" name="yearType" value="period" onclick="updateField('year')"> 周期 从
                                <input type="number" id="yearStart" class="form-control input-sm" style="display: inline-block; width: 100px;" onchange="updateField('year')" placeholder="2024"> -
                                <input type="number" id="yearEnd" class="form-control input-sm" style="display: inline-block; width: 100px;" onchange="updateField('year')" placeholder="2025">
                            </label>
                        </div>
                    </div>
                </div>

                <!-- 表达式显示区域 -->
                <div class="expression-area" style="margin-top: 20px;">
                    <h4>表达式</h4>
                    <div class="form-group">
                        <label>表达式字段:</label>
                        <div class="expression-fields">
                            <div class="field-group">
                                <span class="field-label">秒</span>
                                <input type="text" id="secondField" class="form-control" readonly value="*">
                            </div>
                            <div class="field-group">
                                <span class="field-label">分钟</span>
                                <input type="text" id="minuteField" class="form-control" readonly value="*">
                            </div>
                            <div class="field-group">
                                <span class="field-label">小时</span>
                                <input type="text" id="hourField" class="form-control" readonly value="*">
                            </div>
                            <div class="field-group">
                                <span class="field-label">日</span>
                                <input type="text" id="dayField" class="form-control" readonly value="*">
                            </div>
                            <div class="field-group">
                                <span class="field-label">月</span>
                                <input type="text" id="monthField" class="form-control" readonly value="*">
                            </div>
                            <div class="field-group">
                                <span class="field-label">星期</span>
                                <input type="text" id="weekField" class="form-control" readonly value="?">
                            </div>
                            <div class="field-group">
                                <span class="field-label">年</span>
                                <input type="text" id="yearField" class="form-control" readonly value="">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Cron 表达式:</label>
                        <div class="input-group" style="display: flex; align-items: center;">
                            <input type="text" id="cronExpression" class="form-control" style="flex: 1;">
                            <span class="input-group-btn" style="margin-left: 10px;">
                                <button class="btn btn-default" type="button" onclick="validateCronExpression()" style="height: 34px;">
                                    <i class="fa fa-check"></i> 验证
                                </button>
                            </span>
                        </div>
                        <div id="validationResult" class="alert" style="display:none; margin-top:10px;"></div>
                    </div>

                    <!-- 表达式验证 -->
                    <div class="form-group">
                        <label>表达式验证:</label>
                        <div id="expressionValidation" class="alert" style="display: none; margin-top: 10px;"></div>
                    </div>

                    <!-- 下次执行时间预览 -->
                    <div class="form-group">
                        <label>下次执行时间:</label>
                        <div id="nextExecutionTime" class="well well-sm" style="margin-top: 10px;"></div>
                    </div>

                    <!-- 常用表达式快捷选择 -->
                    <div class="form-group">
                        <label>常用表达式:</label>
                        <div class="btn-group" role="group" style="margin-top: 10px;">
                            <button type="button" class="btn btn-default" onclick="applyQuickExpression('0 0 * * * ?')">每小时</button>
                            <button type="button" class="btn btn-default" onclick="applyQuickExpression('0 0 0 * * ?')">每天0点</button>
                            <button type="button" class="btn btn-default" onclick="applyQuickExpression('0 0 12 * * ?')">每天12点</button>
                            <button type="button" class="btn btn-default" onclick="applyQuickExpression('0 0 0 ? * MON')">每周一0点</button>
                            <button type="button" class="btn btn-default" onclick="applyQuickExpression('0 0 0 1 * ?')">每月1号0点</button>
                            <button type="button" class="btn btn-default" onclick="applyQuickExpression('0 0/5 * * * ?')">每5分钟</button>
                        </div>
                    </div>

                    <!-- 表达式说明和帮助信息 -->
                    <div class="form-group">
                        <label>
                            <a href="javascript:void(0)" onclick="toggleHelp()">
                                <i class="fa fa-question-circle"></i> 表达式说明和帮助
                            </a>
                        </label>
                        <div id="expressionHelp" class="well" style="display: none; margin-top: 10px;">
                            <h5>Cron表达式格式说明：</h5>
                            <p>表达式由7个部分组成：秒 分 时 日 月 周 年（可选）</p>
                            <table class="table table-bordered table-striped">
                                <thead>
                                    <tr>
                                        <th>字段</th>
                                        <th>允许值</th>
                                        <th>允许的特殊字符</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>秒</td>
                                        <td>0-59</td>
                                        <td>, - * /</td>
                                    </tr>
                                    <tr>
                                        <td>分</td>
                                        <td>0-59</td>
                                        <td>, - * /</td>
                                    </tr>
                                    <tr>
                                        <td>时</td>
                                        <td>0-23</td>
                                        <td>, - * /</td>
                                    </tr>
                                    <tr>
                                        <td>日</td>
                                        <td>1-31</td>
                                        <td>, - * ? / L W</td>
                                    </tr>
                                    <tr>
                                        <td>月</td>
                                        <td>1-12</td>
                                        <td>, - * /</td>
                                    </tr>
                                    <tr>
                                        <td>周</td>
                                        <td>1-7</td>
                                        <td>, - * ? / L #</td>
                                    </tr>
                                    <tr>
                                        <td>年</td>
                                        <td>1970-2099</td>
                                        <td>, - * /</td>
                                    </tr>
                                </tbody>
                            </table>
                            <h5>特殊字符说明：</h5>
                            <ul>
                                <li><code>*</code> - 表示所有值</li>
                                <li><code>?</code> - 表示不指定值，仅用于日和周</li>
                                <li><code>-</code> - 表示区间，如：10-12</li>
                                <li><code>,</code> - 表示多个值，如：1,2,3</li>
                                <li><code>/</code> - 表示增量，如：0/15</li>
                                <li><code>L</code> - 用于日和周，表示最后一天或最后一个星期几</li>
                                <li><code>W</code> - 用于日，表示最近的工作日</li>
                                <li><code>#</code> - 用于周，表示第几个星期几，如：6#3 表示第三个星期五</li>
                            </ul>
                            <h5>常用表达式示例：</h5>
                            <ul>
                                <li><code>0 0 * * * ?</code> - 每小时执行一次</li>
                                <li><code>0 0 0 * * ?</code> - 每天0点执行一次</li>
                                <li><code>0 0 12 * * ?</code> - 每天12点执行一次</li>
                                <li><code>0 0 0 ? * MON</code> - 每周一0点执行一次</li>
                                <li><code>0 0 0 1 * ?</code> - 每月1号0点执行一次</li>
                                <li><code>0 0/5 * * * ?</code> - 每5分钟执行一次</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="applyCronExpression()">确定</button>
            </div>
        </div>
    </div>
</div>

@section scripts{
    <script src="~/Scripts/jquery.unobtrusive-ajax.js"></script>
    <script src="~/Scripts/jquery.validate.min.js"></script>
    <script src="~/assets/js/laydate5.0.9/laydate.js"></script>
    <script src="~/Scripts/bootstrap.min.js"></script>
    <script type="text/javascript">
        // Cron表达式生成器相关函数
        function showCronModal() {
            // 获取页面上的Cron表达式值
            var currentExpression = $('#CronExpression').val();
            
            // 如果没有值，则使用默认值
            if (!currentExpression) {
                currentExpression = '* * * * * ?';
            }

            // 分割表达式为各个部分
            var parts = currentExpression.split(' ');

            // 设置各个字段的值
            $('#secondField').val(parts[0] || '*');
            $('#minuteField').val(parts[1] || '*');
            $('#hourField').val(parts[2] || '*');
            $('#dayField').val(parts[3] || '*');
            $('#monthField').val(parts[4] || '*');
            $('#weekField').val(parts[5] || '?');
            if (parts.length > 6) {
                $('#yearField').val(parts[6]);
            } else {
                $('#yearField').val('');
            }

            // 根据各个字段的值设置相应的选项
            setTimeUnitValue('second', parts[0] || '*');
            setTimeUnitValue('minute', parts[1] || '*');
            setTimeUnitValue('hour', parts[2] || '*');
            setTimeUnitValue('day', parts[3] || '*');
            setTimeUnitValue('month', parts[4] || '*');
            setTimeUnitValue('week', parts[5] || '?');
            if (parts.length > 6) {
                setTimeUnitValue('year', parts[6]);
            }

            // 更新Cron表达式显示
            updateCronExpression();

            // 显示模态框
            $('#cronModal').modal('show');
            validateAndPreview();
        }

        function setTimeUnitValue(unit, value) {
            // 重置所有选项
            if (unit === 'year') {
                $(`input[name="${unit}Type"][value="?"]`).prop('checked', true);
            } else {
                $(`input[name="${unit}Type"][value="*"]`).prop('checked', true);
            }
            $(`.${unit}-checkbox`).prop('checked', false);
            $(`#${unit}Start, #${unit}End, #${unit}Begin, #${unit}Interval, #${unit}Work`).val('');

            if (!value || value === '') {
                if (unit === 'year') {
                    $(`input[name="${unit}Type"][value="?"]`).prop('checked', true);
                }
                return;
            }

            if (value === '*') {
                $(`input[name="${unit}Type"][value="*"]`).prop('checked', true);
                return;
            }

            if (value === '?') {
                $(`input[name="${unit}Type"][value="?"]`).prop('checked', true);
                return;
            }

            if (value.includes('/')) {
                // 处理循环格式 x/y
                var parts = value.split('/');
                $(`input[name="${unit}Type"][value="loop"]`).prop('checked', true);
                $(`#${unit}Begin`).val(parts[0]);
                $(`#${unit}Interval`).val(parts[1]);
            }
            else if (value.includes('-')) {
                // 处理周期格式 x-y
                var parts = value.split('-');
                $(`input[name="${unit}Type"][value="period"]`).prop('checked', true);
                $(`#${unit}Start`).val(parts[0]);
                $(`#${unit}End`).val(parts[1]);
            }
            else if (value === 'L' && unit === 'day') {
                // 处理月末
                $(`input[name="${unit}Type"][value="last"]`).prop('checked', true);
            }
            else if (value.endsWith('W') && unit === 'day') {
                // 处理最近工作日
                $(`input[name="${unit}Type"][value="work"]`).prop('checked', true);
                $(`#${unit}Work`).val(value.replace('W', ''));
            }
            else if (value.endsWith('L') && unit === 'week') {
                // 处理本月最后一个星期几
                $(`input[name="${unit}Type"][value="last"]`).prop('checked', true);
                $('#weekLast').val(value.replace('L', ''));
            }
            else if (value.includes(',') || /^\d+$/.test(value)) {
                // 处理指定值
                $(`input[name="${unit}Type"][value="specific"]`).prop('checked', true);
                var values = value.split(',');
                values.forEach(v => {
                    $(`.${unit}-checkbox[value="${v}"]`).prop('checked', true);
                });
            }
        }

        function updateField(unit) {
            var type = $(`input[name="${unit}Type"]:checked`).val();
            var value = '*';

            switch(type) {
                case '*':
                    value = '*';
                    break;
                case '?':
                    if (unit === 'year') {
                        value = '';
                    } else {
                        value = '?';
                    }
                    break;
                case 'period':
                    var start = $(`#${unit}Start`).val();
                    var end = $(`#${unit}End`).val();
                    if (start && end) {
                        value = start + '-' + end;
                    }
                    break;
                case 'loop':
                    var begin = $(`#${unit}Begin`).val();
                    var interval = $(`#${unit}Interval`).val();
                    if (begin && interval) {
                        value = begin + '/' + interval;
                    }
                    break;
                case 'work':
                    if (unit === 'day') {
                        var workDay = $(`#${unit}Work`).val();
                        if (workDay) {
                            value = workDay + 'W';
                        }
                    }
                    break;
                case 'last':
                    if (unit === 'day') {
                        value = 'L';
                    } else if (unit === 'week') {
                        value = $('#weekLast').val() + 'L';
                    }
                    break;
                case 'specific':
                    var selected = [];
                    $(`.${unit}-checkbox:checked`).each(function() {
                        selected.push($(this).val());
                    });
                    value = selected.length > 0 ? selected.join(',') : '*';
                    break;
            }

            $(`#${unit}Field`).val(value);
            updateCronExpression();
        }

        function updateCronExpression() {
            var second = $('#secondField').val();
            var minute = $('#minuteField').val();
            var hour = $('#hourField').val();
            var day = $('#dayField').val();
            var month = $('#monthField').val();
            var week = $('#weekField').val();
            var year = $('#yearField').val();

            var expression = [second, minute, hour, day, month, week];
            if (year) {
                expression.push(year);
            }

            var expressionStr = expression.join(' ');
            $('#cronExpression').val(expressionStr);
            validateAndPreview();
        }

        function applyCronExpression() {
            if (validateCronExpression()) {
                var expression = $('#cronExpression').val();
                $('#CronExpression').val(expression);
                $('#cronModal').modal('hide');
            }
        }

        // 更新验证函数
        function validateCronExpression() {
            var expression = $('#cronExpression').val();
            var resultDiv = $('#validationResult');
            
            // 基本的格式验证
            var parts = expression.split(' ');
            if (parts.length < 6 || parts.length > 7) {
                resultDiv.removeClass('alert-success').addClass('alert-danger')
                    .html('表达式格式错误：必须包含6或7个字段（秒 分 时 日 月 周 [年]）')
                    .show();
                return false;
            }

            // 验证每个字段
            var isValid = true;
            var errorMessage = '';

            // 验证秒
            if (!validateField(parts[0], 0, 59)) {
                isValid = false;
                errorMessage += '秒字段格式错误<br>';
            }

            // 验证分钟
            if (!validateField(parts[1], 0, 59)) {
                isValid = false;
                errorMessage += '分钟字段格式错误<br>';
            }

            // 验证小时
            if (!validateField(parts[2], 0, 23)) {
                isValid = false;
                errorMessage += '小时字段格式错误<br>';
            }

            // 验证日期
            if (!validateField(parts[3], 1, 31, true)) {
                isValid = false;
                errorMessage += '日期字段格式错误<br>';
            }

            // 验证月份
            if (!validateField(parts[4], 1, 12)) {
                isValid = false;
                errorMessage += '月份字段格式错误<br>';
            }

            // 验证星期
            if (!validateField(parts[5], 1, 7, true)) {
                isValid = false;
                errorMessage += '星期字段格式错误<br>';
            }

            // 验证年份（如果存在）
            if (parts.length > 6 && parts[6] !== '') {
                if (!validateField(parts[6], 1970, 2099)) {
                    isValid = false;
                    errorMessage += '年份字段格式错误<br>';
                }
            }

            // 检查日和周的互斥性
            if (parts[3] !== '?' && parts[5] !== '?') {
                isValid = false;
                errorMessage += '日和周不能同时指定具体值，其中一个必须为?<br>';
            }

            if (isValid) {
                resultDiv.removeClass('alert-danger').addClass('alert-success')
                    .html('表达式格式正确')
                    .show();
                return true;
            } else {
                resultDiv.removeClass('alert-success').addClass('alert-danger')
                    .html(errorMessage)
                    .show();
                return false;
            }
        }

        // 验证字段值
        function validateField(field, min, max, allowSpecial) {
            if (field === '*' || field === '?') {
                return true;
            }

            // 处理范围
            if (field.includes('-')) {
                var range = field.split('-');
                if (range.length !== 2) return false;
                return validateNumber(range[0], min, max) && validateNumber(range[1], min, max);
            }

            // 处理列表
            if (field.includes(',')) {
                var values = field.split(',');
                return values.every(function(value) {
                    return validateNumber(value, min, max);
                });
            }

            // 处理步长
            if (field.includes('/')) {
                var parts = field.split('/');
                if (parts.length !== 2) return false;
                if (parts[0] === '*') {
                    return validateNumber(parts[1], 1, max);
                }
                return validateNumber(parts[0], min, max) && validateNumber(parts[1], 1, max);
            }

            // 处理特殊字符
            if (allowSpecial) {
                if (field === 'L' || field.endsWith('W') || field.includes('#')) {
                    return true;
                }
            }

            // 处理英文星期表示
            if (min === 1 && max === 7) { // 星期字段
                var weekMap = {
                    'SUN': '1', 'MON': '2', 'TUE': '3', 'WED': '4', 
                    'THU': '5', 'FRI': '6', 'SAT': '7',
                    '1': '1', '2': '2', '3': '3', '4': '4', '5': '5', '6': '6', '7': '7'
                };
                
                // 处理单个值
                var upperField = field.toUpperCase();
                if (weekMap[upperField]) {
                    return true;
                }

                // 处理范围
                if (field.includes('-')) {
                    var range = field.split('-');
                    if (range.length === 2) {
                        var start = range[0].trim().toUpperCase();
                        var end = range[1].trim().toUpperCase();
                        return weekMap[start] && weekMap[end] && parseInt(weekMap[start]) <= parseInt(weekMap[end]);
                    }
                }

                // 处理列表
                if (field.includes(',')) {
                    var values = field.split(',');
                    return values.every(function(value) {
                        return weekMap[value.trim().toUpperCase()] !== undefined;
                    });
                }

                // 处理特殊格式
                if (field.includes('#')) {
                    var parts = field.split('#');
                    if (parts.length === 2) {
                        var day = parts[0].trim().toUpperCase();
                        var week = parseInt(parts[1]);
                        return weekMap[day] && week >= 1 && week <= 5;
                    }
                }

                // 处理L结尾
                if (field.endsWith('L')) {
                    var day = field.substring(0, field.length - 1).trim().toUpperCase();
                    return weekMap[day] !== undefined;
                }
            }

            // 处理单个数字
            return validateNumber(field, min, max);
        }

        // 验证数字
        function validateNumber(value, min, max) {
            var num = parseInt(value);
            return !isNaN(num) && num >= min && num <= max;
        }

        // 应用快捷表达式
        function applyQuickExpression(expression) {
            $('#cronExpression').val(expression);
            validateCronExpression();
        }

        // 切换帮助信息显示
        function toggleHelp() {
            $('#expressionHelp').slideToggle();
        }

        // 计算下次执行时间
        function calculateNextExecutionTimes(expression) {
            var nextTimeDiv = $('#nextExecutionTime');
            nextTimeDiv.empty();

            if (!validateCronExpression()) {
                nextTimeDiv.html('表达式无效，无法计算执行时间');
                return;
            }

            // 暂时不显示执行时间
            nextTimeDiv.html('执行时间计算功能暂未开放');
        }

        // 验证并预览
        function validateAndPreview() {
            validateCronExpression();
            calculateNextExecutionTimes();
        }

        $(document).ready(function () {
            hos.ui.util.formValidate("form1");
            var startTime = laydate.render({
                elem: '#StartDate', type: 'datetime', done: function (value, date, endDate) {
                    date.month = date.month - 1;
                    endTime.config.min = date;
                    $(endTime.config.elem).focus();
                }
            });
            var endTime = laydate.render({
                elem: '#EndDate', type: 'datetime', done: function (value, date, endDate) {
                    date.month = date.month - 1;
                    startTime.config.max = date;
                }
            });
            $("#RunLoop").click(function () {
                if (this.checked) {
                    $("#ctn_CronExpression").removeClass("hide");
                    $("#CronExpression").rules("add", { required: true });
                } else {
                    $("#ctn_CronExpression").addClass("hide");
                    $("#RunLoop").removeAttr("checked");
                    $("#CronExpression").rules("remove", "required");
                }
            });
            if (handlers.taskId) {
                handlers.loadTaskDetail();
            }
        });

        var handlers = {
            taskId: '@_httpContextAccessor.HttpContext.Request.Query["id"]',
            loadTaskDetail: function () {
                $.getJSON("/api/Task/QueryTaskDetail?id=" + handlers.taskId, {}, function (result) {
                    if (result && result.Status === 1) {
                        $("#id").val(handlers.taskId);
                        $("#Title").val(result.Data.Title);
                        $("#CronExpression").val(result.Data.CronExpression);
                        if (result.Data.RunLoop) {
                            $("#CronExpression").rules("add", { required: true });
                        } else {
                            $("#ctn_CronExpression").addClass("hide");
                            $("#RunLoop").removeAttr("checked");
                            $("#CronExpression").rules("remove", "required");
                        }
                        $("#AssemblyName").val(result.Data.AssemblyName);
                        $("#ClassName").val(result.Data.ClassName);
                        $("#CustomParamsJson").val(result.Data.CustomParamsJson);
                        $("#StartDate").val(result.Data.StartDate);
                        $("#EndDate").val(result.Data.EndDate);
                        $("#Remark").val(result.Data.Remark);
                    }
                });
            },
            beforeSubmit: function () {
                //hos.ui.util.showLoading();
            },
            onComplete: function (xhr, state) {
                //hos.ui.util.hideLoading();
                var data = xhr.responseJSON;
                if (data.Status === 1) {
                    hos.ui.util.infoTip(data.Message, "/task/index");
                } else {
                    hos.ui.util.errorTip(data.Message);
                }
            }
        }
    </script>
}